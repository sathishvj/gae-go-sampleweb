package helloappengine

import (
	"appengine"
	"appengine/datastore"
	"html/template"
	"net/http"
	"time"
)

type Info struct {
	Data string
	Time time.Time
}

func init() {
	http.HandleFunc("/", onRoot)
	http.HandleFunc("/add", onAdd)
}

func onRoot(w http.ResponseWriter, r *http.Request) {
	t, _ := template.New("root").Parse(tmplStr)

	t.ExecuteTemplate(w, "root", nil)
}

func onAdd(w http.ResponseWriter, r *http.Request) {
	c := appengine.NewContext(r)
	s := r.FormValue("info")
	addInfo(c, s)

	onRoot(w, r)
}

func addInfo(c appengine.Context, s string) {
	key := datastore.NewIncompleteKey(c, "Info", nil)

	newInfo := Info{
		s,
		time.Now(),
	}
	datastore.Put(c, key, &newInfo)
}

var tmplStr = `
{{define "root"}}
<html>
<body>
	<h3>Enter new info:</h3>
	<form action="/add">
		<input name="info" type="text">
		<input type="submit">
	</form>
</body>
</html>
{{end}}
`
